## mako

<%page expression_filter="h"/>
<%namespace name='static' file='../static_content.html'/>

<%!
import json

from django.conf import settings
from django.utils.translation import ugettext as _
from django.template.defaultfilters import escapejs
from django.urls import reverse

from lms.djangoapps.discussion.django_comment_client.permissions import has_permission
from openedx.core.djangolib.js_utils import dump_js_escaped_json, js_escaped_string
from openedx.core.djangolib.markup import Text, HTML
from openedx.features.course_experience import UNIFIED_COURSE_TAB_FLAG, SHOW_REVIEWS_TOOL_FLAG
from openedx.features.course_experience.course_tools import HttpMethod
%>

<%block name="header_extras">
  <link rel="stylesheet" type="text/css" href="${static.url('paragon/static/paragon.min.css')}" />
</%block>

<%block name="content">
<div class="course-view page-content-container" id="course-container">
    <div class="page-content">
        <div class="page-content-main">
            % if next_up_banner_fragment:
                ${HTML(next_up_banner_fragment.body_html())}
            % endif
            % if offer_banner_fragment:
                ${HTML(offer_banner_fragment.content)}
            % endif
            % if course_expiration_fragment:
                ${HTML(course_expiration_fragment.content)}
            % endif
            % if course_home_message_fragment:
                ${HTML(course_home_message_fragment.body_html())}
            % endif

            % if update_message_fragment and UNIFIED_COURSE_TAB_FLAG.is_enabled(course.id):
                <div class="section section-update-message">
                    ${HTML(update_message_fragment.body_html())}
                </div>
            % endif

            % if outline_fragment:
                ${HTML(outline_fragment.body_html())}
            % endif
        </div>
        <div class="page-content-overview">
                <!-- block bottom profil -->
            <div class="overview_box" id="overview_grades_list">
                <div class="progress-container">
                    <%
                    grades_summary_len = len(grade_summary.get("section_breakdown"))
                    global_score = grade_summary.get('percent')
                    mark = 0
                    %>
                    <div class="progress-bar progress-bar_total" data-effect="1" data-value="${round(global_score, 2)*100}" data-skill="${_('Your final grade')}"></div>
                    % for n in grade_summary.get("section_breakdown"):
                    <% mark = mark + 1 %>
                    <div class="progress-bar progress-bar_exercie" data-effect="1" data-value="${round(n.get('percent'), 2)*100}" data-skill="${n.get('detail')}"></div>
                    % endfor
                </div>
                <button class="edit-icon">
                    <span>Download certificate</span>
                </button>
            </div>
            <div id="overwiew_aside_completion">
                <div class="overview_box" id="overwiew_aside_completion">
                    You have completed ${round(completion_rate, 2)}% of the course content!
                    <br />${remaining_days} days remaining before the end of the course
                </div>
                <div class="overview_box" id="overwiew_aside_chat">
                    <a href="/courses/${course.id}/discussion/forum/">Come and chat with us</a>
                </div>
                <div  class="overview_box" id="overwiew_aside_summary">
                    <img src="${course_overview.course_image_url}" align="right" />
                    <div id="overwiew_aside_summary_text">
                        ${course_overview.short_description}
                    </div>
                </div>
            </div>
            <div class="overview_box" id="overview_course_achievements">
                <h2>Achievements</h2>
                <h3>Badges :</h3>
                <div class="${(completion_rate >= 25 and 'badge_success') or ''}">25% completion</div>
                <div class="${(completion_rate >= 50 and 'badge_success') or ''}">50% completion</div>
                <div class="${(completion_rate >= 75 and 'badge_success') or ''}">75% completion</div>
                <div class="${(completion_rate == 1 and 'badge_success') or ''}">100% completion</div>
                <div class="${(completion_rate == 1 and global_score*100 > course.lowest_passing_grade and 'badge_success') or ''}">Note Passed</div>
                <div class="${(completion_rate == 1 and global_score*100 > (1 - course.lowest_passing_grade / 2) and 'badge_success') or ''}">Note > 100%-passed/2</div>
                <div class="${(completion_rate == 1 and global_score*100 == 1 and 'badge_success') or ''}">Note = 100%</div>
            </div>
        </div>
    </div>
    % if course_sock_fragment:
        ${HTML(course_sock_fragment.body_html())}
    % endif
</div>
</%block>

<%static:webpack entry="CourseHome">
    new CourseHome({
        courseRunKey: "${course_key | n, js_escaped_string}",
        resumeCourseLink: ".action-resume-course",
        courseToolLink: ".course-tool-link",
        goalApiUrl: "${goal_api_url | n, js_escaped_string}",
        username: "${username | n, js_escaped_string}",
        courseId: "${course.id | n, js_escaped_string}",
    });
</%static:webpack>

<%static:webpack entry="Enrollment">
    new CourseEnrollment('.enroll-btn', '${course_key | n, js_escaped_string}');
</%static:webpack>


<!-- PROGRESS BARS -->
<script>
//function for adding <span> elements for value and skill name
    function additionalElems(progressElement, value, skillName) {

//adding value
var valueChild = document.createElement('span');
valueChild.className = 'progress-bar__value';
valueChild.innerHTML = value +'%';
progressElement.appendChild(valueChild);

//adding bar area
var barChild = document.createElement('div');
barChild.className = 'progress-bar__bar';
progressElement.appendChild(barChild);

//adding inner area with the width of value
var barInnerChild = document.createElement('div');
barInnerChild.className = 'progress-bar__bar-inner';
barInnerChild.style.width = value + '%';
barChild.appendChild(barInnerChild);


//adding skillName
var skillChild = document.createElement('span');
skillChild.className = 'progress-bar__skill';
skillChild.innerHTML = skillName;
progressElement.appendChild(skillChild);
}

//adding <span> elements for value and skill name
var progressBar = document.querySelectorAll('.progress-bar');

progressBar.forEach(function(item) {

var self = item,
    barValue = self.getAttribute('data-value'),
    skillValue = self.getAttribute('data-skill'),
    effectNum = self.getAttribute('data-effect');

additionalElems(self, barValue, skillValue);

//adding special BEM classes to every progress bar element (to set classes for effects)
self.className += ' progress-bar--' + effectNum;

var valueElem = self.querySelector('.progress-bar__value');
  
valueElem.className += ' progress-bar__value--' + effectNum;

var barElem = self.querySelector('.progress-bar__bar');

barElem.className += ' progress-bar__bar--' + effectNum;

var barInnerElem = self.querySelector('.progress-bar__bar-inner');

barInnerElem.className += ' progress-bar__bar-inner--' + effectNum;

var skillElem = self.querySelector('.progress-bar__skill');
  
  skillElem.className += ' progress-bar__skill--' + effectNum;

//adding alignment for values
if(self.classList.contains('progress-bar--aligned-values')) {
   valueElem.style.left = barValue + '%';
   valueElem.classList.add('progress-bar__value--aligned-value');
}

//adding additional class for no overflow hidden
if(self.classList.contains('progress-bar--no-overflow')) {
   barElem.classList.add('progress-bar__bar--no-overflow');
}

})

//function for animation toggling
function animationToggle(progressElement, delay) {

  var skillElem = progressElement.querySelector('.progress-bar__skill'),
      valueElem = progressElement.querySelector('.progress-bar__value'),
      skillBar = progressElement.querySelector('.progress-bar__bar-inner');

//removing animated classes, returning to start position
skillElem.classList.remove('js-animated');
valueElem.classList.remove('js-animated');
skillBar.classList.remove('js-animated');

//adding animated classes to start animation
setTimeout(function() {
  skillElem.classList.add('js-animated');
  valueElem.classList.add('js-animated');
  skillBar.classList.add('js-animated');
}, delay);
}

//add animation onload
function onloadAnimation() {

progressBar.forEach(function(item) {
  animationToggle(item, 500)
});

}

document.addEventListener("DOMContentLoaded", onloadAnimation());
</script>